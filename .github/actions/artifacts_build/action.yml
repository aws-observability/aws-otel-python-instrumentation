name: Build and Push aws-opentelemetry-distro
description: |
  This action assumes that the repo was checked out. Builds and pushes/loads wheel and image files.

inputs:
  aws-region:
    required: true
    description: "AWS Region"
  image_uri_with_tag:
    required: true
    description: "Image URI with Tag"
  image_registry:
    required: true
    description: "Image Registry"
  snapshot-ecr-role:
    require: true
    description: "IAM Role used for pushing to snapshot ecr"
  push_image:
    required: true
    description: "Whether push image to ECR"
  load_image:
    required: true
    description: "Whether load the image for the following use, only load in PR build"
  python_version:
    required: true
    description: "The python version used in actions"
  package_name:
    required: true
    description: "The package name"
  os:
    required: true
    description: "The os"
  e2e_secret_test_role_arn:
    required: false
    description: "Test account Assume Role part 1"
  python_e2e_test_role_arn:
    required: false
    description: "Test account Assume Role part 2"
  test_image_uri_with_tag:
    required: false
    description: "Test Image URI with Tag"

runs:
  using: "composite"
  steps:
    - name: Set up
      uses: ./.github/actions/set_up
      with:
        python_version: ${{ inputs.python_version }}
        package_name: ${{ inputs.package_name }}
        os: ${{ inputs.os }}
        run_unit_tests: true

    - name: Install Dependencies and Build Wheel
      id: staging_wheel_build
      shell: bash
      run: |
        pip install --upgrade pip setuptools wheel packaging build
        rm -rf ./dist/*
        cd ./aws-opentelemetry-distro
        python -m build --outdir ../dist

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # TODO: The next 5 steps are temporary until Python ADOT image is publicly released.
    # They will be removed then
    - name: Configure AWS Credentials
      if: ${{ inputs.e2e_secret_test_role_arn != "" }}
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ inputs.e2e_secret_test_role_arn }}
        aws-region: us-east-1
    - name: Retrieve account
      if: ${{ inputs.e2e_secret_test_role_arn != "" }}
      uses: aws-actions/aws-secretsmanager-get-secrets@v1
      with:
        secret-ids:
          ACCOUNT_ID, region-account/${{ inputs.aws-region }}
    - name: Configure AWS Credentials
      if: ${{ inputs.e2e_secret_test_role_arn != "" }} && ${{ inputs.python_e2e_test_role_arn != "" }}
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::${{ env.ACCOUNT_ID }}:role/${{ inputs.python_e2e_test_role_arn }}
        aws-region: ${{ inputs.aws-region }}
    - name: Login to Amazon ECR
      if: ${{ inputs.e2e_secret_test_role_arn != "" }} && ${{ inputs.python_e2e_test_role_arn != "" }}
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
    - name: Build and push image according to input
      if: ${{ inputs.e2e_secret_test_role_arn != "" }} && ${{ inputs.python_e2e_test_role_arn != "" }} && ${{ inputs.test_image_uri_with_tag != "" }}
      uses: docker/build-push-action@v5
      with:
        push: ${{ inputs.push_image }}
        context: .
        file: ./Dockerfile
        platforms: linux/amd64
        tags: ${{ inputs.test_image_uri_with_tag }}
        load: ${{ inputs.load_image }}

    - name: Configure AWS Credentials
      if: ${{ inputs.push_image == true || inputs.push_image == 'true' }}
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ inputs.snapshot-ecr-role }}
        aws-region: ${{ inputs.aws-region }}

    - name: Login to AWS ECR
      if: ${{ inputs.push_image == true || inputs.push_image == 'true' }}
      uses: docker/login-action@v3
      with:
        registry: ${{ inputs.image_registry }}
      env:
        AWS_REGION: ${{ inputs.aws-region }}

    - name: Build and push image according to input
      uses: docker/build-push-action@v5
      with:
        push: ${{ inputs.push_image }}
        context: .
        file: ./Dockerfile
        platforms: linux/amd64
        tags: ${{ inputs.image_uri_with_tag }}
        load: ${{ inputs.load_image }}